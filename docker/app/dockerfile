FROM amazoncorretto:21-alpine
WORKDIR /app

LABEL maintainer="UMC PRODUCT SERVER TEAM"
LABEL description="UMC PRODUCT Official SpringBoot Backend Server"

# curl 설치 (헬스체크용) + non-root 유저 생성
RUN apk add --no-cache curl && \
    addgroup -S spring && \
    adduser -S spring -G spring && \
    mkdir -p /app/logs && \
    chown -R spring:spring /app

# 이미 build된 jar 파일을 docker 안으로 복사
COPY --chown=spring:spring build/libs/*.jar app.jar
RUN chmod 444 app.jar

# 로그 디렉토리 생성 및 권한 설정
RUN mkdir -p /app/logs && chown -R spring:spring /app/logs

# Switch to non-root user
USER spring:spring

# Expose application port
EXPOSE 8080

# JVM options
ENV JAVA_OPTS="-XX:+UseContainerSupport \
               -XX:MaxRAMPercentage=75.0 \
               -XX:+UseG1GC \
               -XX:+ExitOnOutOfMemoryError \
               -XX:+HeapDumpOnOutOfMemoryError \
               -XX:HeapDumpPath=/tmp/heapdump.hprof \
               -Duser.timezone=Asia/Seoul \
               -Djava.security.egd=file:/dev/./urandom"

# Use exec form with sh -c so JAVA_OPTS is expanded and signals forwarded
ENTRYPOINT ["sh", "-c", "exec java $JAVA_OPTS -jar app.jar"]

# Optional healthcheck (uncomment if actuator/health endpoint exists)
# HEALTHCHECK --interval=30s --timeout=5s CMD curl -f http://localhost:8080/actuator/health || exit 1
