name: CD [ECR-ECS]

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'docker/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cd.yml'
      - '.github/workflows/cd-ecr.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - Development
          - Production

jobs:
  ci-and-build:
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write
      packages: write
      statuses: write
      deployments: write
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}

  deploy:
    needs: ci-and-build
    if: needs.ci-and-build.outputs.environment != 'test'
    #    runs-on: ubuntu-latest
    runs-on: [ self-hosted, cd-runner ]
    environment: ${{ needs.ci-and-build.outputs.environment }}

    env:
      ENVIRONMENT: ${{ needs.ci-and-build.outputs.environment }}
      IMAGE_TAG: ${{ needs.ci-and-build.outputs.image_tag }}
      AWS_REGION: ap-northeast-2
      ECS_CLUSTER: ${{ secrets.AWS_ECS_CLUSTER }}
      ECS_SERVICE: ${{ secrets.AWS_ECS_SERVICE }}

    steps:
      - name: ğŸ”‘ AWS ì¸ì¦
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸš€ ECS ì„œë¹„ìŠ¤ ë°°í¬
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ ë°°í¬ ì‹œì‘: ${{ env.ENVIRONMENT }}"
          echo "ğŸ“¦ Image Tag: ${{ env.IMAGE_TAG }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment \
            --no-cli-pager

          echo ""
          echo "â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}

          echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "### ğŸš€ ECS Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ¿ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Image Tag | \`${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Cluster | \`${{ env.ECS_CLUSTER }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Status | \`${{ job.status }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "::error::ECS deployment to ${{ env.ENVIRONMENT }} failed!"
          echo "CloudWatch ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”"

  skip-test-deployment:
    needs: ci-and-build
    if: needs.ci-and-build.outputs.environment == 'test'
    runs-on: ubuntu-latest
    steps:
      - name: â„¹ï¸ Test í™˜ê²½ ë°°í¬ ìŠ¤í‚µ
        run: echo "Test í™˜ê²½ì€ CIë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤."
