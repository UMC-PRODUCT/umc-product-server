name: CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'docker/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cd.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        type: choice
        options:
          - Development
          - Production

jobs:
  # 1. ê³µí†µ ë¹Œë“œ/í…ŒìŠ¤íŠ¸ ì›Œí¬í”Œë¡œìš° í˜¸ì¶œ (ci.yml ìž¬ì‚¬ìš©)
  ci-and-build:
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write
      packages: write
      statuses: write
      deployments: write
    secrets: inherit
    with:
      environment: ${{ inputs.environment }}

  # 2. Deploy Job
  deploy:
    needs: ci-and-build
    if: needs.ci-and-build.outputs.environment != 'test'
    runs-on: [ self-hosted, cd-runner ]
    # ë¹Œë“œ ë‹¨ê³„ì—ì„œ ê²°ì •ëœ í™˜ê²½ ì‚¬ìš©
    environment: ${{ needs.ci-and-build.outputs.environment }}

    env:
      ENVIRONMENT: ${{ needs.ci-and-build.outputs.environment }}
      REPO_OWNER: ${{ needs.ci-and-build.outputs.repo_owner }}
      IMAGE_TAG: ${{ needs.ci-and-build.outputs.image_tag }}

    steps:
      - name: ðŸ” í™˜ê²½ë³€ìˆ˜ ê²€ì¦
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPOSITORY_NAME: ${{ secrets.DOCKERHUB_REPOSITORY_NAME }}
          SERVER_APP_DIRECTORY: ${{ secrets.SERVER_APP_DIRECTORY }}
          SERVER_SSH_HOST: ${{ secrets.SERVER_SSH_HOST }}
          SERVER_SSH_USERNAME: ${{ secrets.SERVER_SSH_USERNAME }}
          SERVER_SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          SERVER_SSH_PORT: ${{ secrets.SERVER_SSH_PORT }}
          DOCKER_COMPOSE_ENV: ${{ secrets.DOCKER_COMPOSE_ENV }}
          APPLICATION_PROFILE_SECRET: ${{ secrets.APPLICATION_PROFILE_SECRET }}
          APP_ENVIRONMENT: ${{ env.ENVIRONMENT }}
          APP_IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì‹œìž‘..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MISSING_VARS=()
          
          echo "ðŸ“¦ Docker Hub ìžê²©ì¦ëª… í™•ì¸..."
          [[ -z "$DOCKERHUB_USERNAME" ]] && MISSING_VARS+=("DOCKERHUB_USERNAME")
          [[ -z "$DOCKERHUB_TOKEN" ]] && MISSING_VARS+=("DOCKERHUB_TOKEN")
          [[ -z "$DOCKERHUB_REPOSITORY_NAME" ]] && MISSING_VARS+=("DOCKERHUB_REPOSITORY_NAME")
          
          echo "ðŸ” SSH ì ‘ì† ì •ë³´ í™•ì¸..."
          [[ -z "$SERVER_APP_DIRECTORY" ]] && MISSING_VARS+=("SERVER_APP_DIRECTORY")
          [[ -z "$SERVER_SSH_HOST" ]] && MISSING_VARS+=("SERVER_SSH_HOST")
          [[ -z "$SERVER_SSH_USERNAME" ]] && MISSING_VARS+=("SERVER_SSH_USERNAME")
          [[ -z "$SERVER_SSH_PRIVATE_KEY" ]] && MISSING_VARS+=("SERVER_SSH_PRIVATE_KEY")
          [[ -z "$SERVER_SSH_PORT" ]] && MISSING_VARS+=("SERVER_SSH_PORT")
          
          echo "âš™ï¸  ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • í™•ì¸..."
          [[ -z "$DOCKER_COMPOSE_ENV" ]] && MISSING_VARS+=("DOCKER_COMPOSE_ENV")
          [[ -z "$APPLICATION_SECRET" ]] && MISSING_VARS+=("APPLICATION_SECRET")
          [[ -z "$APPLICATION_PROFILE_SECRET" ]] && MISSING_VARS+=("APPLICATION_PROFILE_SECRET")
          
          echo "ðŸŒ í™˜ê²½ ë³€ìˆ˜ í™•ì¸..."
          [[ -z "$APP_ENVIRONMENT" ]] && MISSING_VARS+=("ENVIRONMENT")
          [[ -z "$APP_IMAGE_TAG" ]] && MISSING_VARS+=("IMAGE_TAG")
          
          if [ ${#MISSING_VARS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ë“¤ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:"
            printf '   â€¢ %s\n' "${MISSING_VARS[@]}"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… ëª¨ë“  í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ðŸ“¥ ì½”ë“œë² ì´ìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ“‹ ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ ë°°í¬ ì •ë³´"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ Environment: ${{ env.ENVIRONMENT }}"
          echo "ðŸ“¦ Image Tag: ${{ env.IMAGE_TAG }}"
          echo "ðŸ“ App Directory: ${{ secrets.SERVER_APP_DIRECTORY }}"
          echo "ðŸ–¥ï¸  Server: ${{ secrets.SERVER_SSH_HOST }}"
          echo "ðŸ‘¤ User: ${{ secrets.SERVER_SSH_USERNAME }}"
          echo "ðŸ”Œ Port: ${{ secrets.SERVER_SSH_PORT }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


      - name: ðŸ“¤ Docker Compose íŒŒì¼ ì „ì†¡
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          source: "docker/app/docker-compose.yml"
          target: "${{ secrets.SERVER_APP_DIRECTORY }}/"
          strip_components: 2
          overwrite: true

      - name: ðŸš€ SSH ì ‘ì† ë° ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_USERNAME }}
          key: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            echo "=============================="
            echo "ðŸš€ ë°°í¬ ì‹œìž‘: ${{ env.ENVIRONMENT }} í™˜ê²½"
            echo "=============================="
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export XDG_RUNTIME_DIR=/run/user/$(id -u)
            export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/docker.sock
            export PATH="$PATH:/usr/local/bin"
            
            # Docker í™˜ê²½ ê²€ì¦
            echo "[1] Docker í™˜ê²½ í™•ì¸"
            echo "  - DOCKER_HOST: $DOCKER_HOST"
            echo "  - User ID: $(id -u)"
            echo "  - Docker Path: $(which docker)"
            
            if ! docker info &>/dev/null; then
              echo "âŒ Docker daemonì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              echo "Docker ì„œë¹„ìŠ¤ ìƒíƒœ:"
              systemctl --user status docker
              exit 1
            fi
            echo "âœ… Docker í™˜ê²½ ì •ìƒ"
            
            # Docker Hub ë¡œê·¸ì¸
            echo ""
             echo "[2] Docker Hub ë¡œê·¸ì¸ (GHCR)"
            # echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
            
            # GHCR ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            if [ $? -eq 0 ]; then
              echo "âœ… Docker Hub ë¡œê·¸ì¸ ì„±ê³µ"
            else
              echo "âŒ Docker Hub ë¡œê·¸ì¸ ì‹¤íŒ¨"
              exit 1
            fi
            
            # App Directoryê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
            echo ""
            echo "[3] ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ í™•ì¸: ${{ secrets.SERVER_APP_DIRECTORY }}"
            if [ ! -d "${{ secrets.SERVER_APP_DIRECTORY }}" ]; then
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              exit 1
            else
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤."
            fi
            
            # Docker Compose íŒŒì¼ìš© env ë¡œë”©
            echo ""
            echo "ðŸ“ Docker Compose ìš© .env íŒŒì¼ ìƒì„± ì¤‘..."
            echo "${{ secrets.DOCKER_COMPOSE_ENV }}" > ${{ secrets.SERVER_APP_DIRECTORY }}/.env
            echo "âœ… Docker Compose ìš© .env íŒŒì¼ ìƒì„± ì™„ë£Œ"
            
            # SpringBoot Config íŒŒì¼ë“¤ ë¡œë”©
            echo ""
            echo "ðŸ“ Spring Boot ì„¤ì • íŒŒì¼ ìƒì„± ì¤‘..."
            
            case "$ENVIRONMENT" in
              "Production") PROFILE="prod" ;;
              "Development") PROFILE="dev" ;;
              "Test") PROFILE="test" ;;
              *) PROFILE="dev" ;;
            esac
            
            mkdir -p ${{ secrets.SERVER_APP_DIRECTORY }}/config
            
            # application-secret.ymlì„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ë³€ê²½í•¨ì— ë”°ë¼ ì œê±°
            
            cat > ${{ secrets.SERVER_APP_DIRECTORY }}/config/application-${PROFILE}.yml << 'EOF'
            ${{ secrets.APPLICATION_PROFILE_SECRET }}
            EOF
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo ""
            echo "ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤, ì´ì „ ìœ„ì¹˜: $(pwd)"
            cd ${{ secrets.SERVER_APP_DIRECTORY }}
            echo "ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. í˜„ìž¬ ìœ„ì¹˜: $(pwd)"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“¥ Docker ì´ë¯¸ì§€ Pull"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose pull
            
            echo "ðŸ›‘ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker compose down
            
            echo "ðŸš€ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì¤‘..."
            docker compose up -d --remove-orphans
            
            if [ $? -ne 0 ]; then
              echo "âŒ ì»¨í…Œì´ë„ˆ ì‹œìž‘ ì‹¤íŒ¨"
              echo ""
              echo "ðŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
              docker compose logs --tail=50
              exit 1
            fi
            
            echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤"
            echo ""
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ðŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker compose ps
            echo ""
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸŽ‰ ë°°í¬ ì™„ë£Œ!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Environment | \`${{ env.ENVIRONMENT }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Image | \`${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ–¥ï¸ Server | \`${{ secrets.SERVER_SSH_HOST }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Directory | \`${{ secrets.SERVER_APP_DIRECTORY }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Status | \`${{ job.status }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
          echo "### âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          else
          echo "### âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi

      - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ë°°í¬ ì‹¤íŒ¨"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "í™˜ê²½: ${{ env.ENVIRONMENT }}"
          echo "ì´ë¯¸ì§€: ${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ env.IMAGE_TAG }}"
          echo "ì„œë²„: ${{ secrets.SERVER_SSH_HOST }}"
          echo ""
          echo "::error::Deployment to ${{ env.ENVIRONMENT }} failed!"
          echo "::error::Please check the deployment logs for details."

  # 3. Test í™˜ê²½ ìŠ¤í‚µ ì•Œë¦¼
  skip-test-deployment:
    needs: ci-and-build
    if: needs.ci-and-build.outputs.environment == 'test'
    runs-on: ubuntu-latest
    steps:
      - name: â„¹ï¸ Test í™˜ê²½ ë°°í¬ ìŠ¤í‚µ
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â„¹ï¸  Test í™˜ê²½ ë°°í¬ ìŠ¤í‚µ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Test í™˜ê²½ì€ CIì—ì„œë§Œ ë¹Œë“œí•˜ê³  ë°°í¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo ""
          echo "âœ… CI ë¹Œë“œ ì™„ë£Œ"
          echo "ðŸ“¦ ì´ë¯¸ì§€: ${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ needs.ci-and-build.outputs.image_tag }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“Š Summary
        run: |
          echo "### â„¹ï¸ Test Environment - Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test í™˜ê²½ì€ CIì—ì„œë§Œ ë¹Œë“œí•˜ê³  ì‹¤ì œ ë°°í¬ëŠ” ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **CI Build**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Image**: \`${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ needs.ci-and-build.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš« **Deployment**: Skipped" >> $GITHUB_STEP_SUMMARY
