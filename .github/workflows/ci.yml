name: CI

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'build.gradle.kts'
      - 'docker/**'
      - '.github/workflows/ci.yml'
      - '.github/workflows/cd.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ (prod/dev)'
        required: true
        type: choice
        options:
          - Development
          - Production
          - Test

  workflow_call:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: false
        type: string
    outputs:
      environment:
        description: "ê²°ì •ëœ í™˜ê²½"
        value: ${{ jobs.build-and-test.outputs.environment }}
      repo_owner:
        description: "Repository owner"
        value: ${{ jobs.build-and-test.outputs.repo_owner }}
      image_tag:
        description: "Docker image tag"
        value: ${{ jobs.build-and-test.outputs.image_tag }}

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # ì´ì „ ì‹¤í–‰ ì·¨ì†Œ

jobs:
  # Job 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (í•œ ë²ˆë§Œ ì‹¤í–‰)
  build-and-test:
    runs-on: self-hosted

    permissions:
      contents: read
      checks: write
      pull-requests: write

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      repo_owner: ${{ steps.set-env.outputs.repo_owner }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}

    #    strategy:
    #      matrix:
    #        platform: [ linux/amd64, linux/arm64 ]
    #        include:
    #          - platform: linux/amd64
    #            tag-suffix: amd64
    #          - platform: linux/arm64
    #            tag-suffix: arm64

    steps:
      - name: ðŸ“¦ ì½”ë“œë² ì´ìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸŽ¯ ë°°í¬ í™˜ê²½ ì„¤ì •
        id: set-env
        run: |
          INPUT_ENV="${{ inputs.environment }}"

          # PRì¼ ë•ŒëŠ” 'test' í™˜ê²½ìœ¼ë¡œ ì„¤ì •
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in PR mode - Setting test environment for build"
            ENVIRONMENT="Test"
          elif [[ -n "$INPUT_ENV" ]]; then
            ENVIRONMENT="$INPUT_ENV"
          
          # CDì—ì„œ í˜¸ì¶œí•œ ê²½ìš° branchì— ë”°ë¼ì„œ í™˜ê²½ ê²°ì •
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENVIRONMENT="Production"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENVIRONMENT="Development"
          else
            ENVIRONMENT="Test"
          fi

          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=${REPO_OWNER}" >> $GITHUB_OUTPUT

          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${ENVIRONMENT}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: ðŸ§‘â€ðŸ’» JDK 21 Corretto ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: ðŸ”‘ Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: ðŸ” ì»´íŒŒì¼ ì²´í¬
        run: ./gradlew compileJava compileTestJava

      - name: ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test

      - name: ðŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°°í¬
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/test/*.xml
          check_name: "Backend Test Results"

      - name: ðŸ—ï¸ Build JAR
        run: ./gradlew bootJar

      - name: ðŸ“‹ ë¹Œë“œ ê²°ê³¼ í™•ì¸
        run: |
          ls -la build/libs/
          echo "Current directory: $(pwd)"

      - name: ðŸ–¥ï¸ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ³ Build and Push Docker Image
        uses: docker/build-push-action@v6
        # tagsì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„, DockerHubê°€ ì•„ë‹Œ GitHub Container Registryë¡œ ë³€ê²½
        #            ${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ steps.set-env.outputs.image_tag }}
        #            ${{ secrets.DOCKERHUB_REPOSITORY_NAME }}:${{ steps.set-env.outputs.environment }}-latest
        with:
          context: .
          file: docker/app/dockerfile
          push: ${{ github.event_name != 'pull_request' }} # PRì˜ ê²½ìš° ë¹Œë“œê¹Œì§€ë§Œ í•˜ê³  DockerHubì— í‘¸ì‹œí•˜ì§€ ì•ŠìŒ
          tags: |
            ghcr.io/${{ github.repository_owner }}/server:${{ steps.set-env.outputs.image_tag }}
            ghcr.io/${{ github.repository_owner }}/server:${{ steps.set-env.outputs.environment }}-latest
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          #          cache-to: type=gha,mode=max
          cache-to: type=gha,mode=min

      - name: ðŸ“ Build Summary
        if: always()
        run: |
          echo "### Build Summary :package:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.set-env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.set-env.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
