# ==================================================================
# 공통 설정 파일, 환경변수화 되어 있는 부분은 프로필별 설정에서 반드시 오버라이드할 것!
# 환경변수 변경 시에는 반드시 GitHub Actions에 업데이트 할 것
# ==================================================================


server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful
  forward-headers-strategy: framework

  # 톰캣 튜닝 옵션 - 부하테스트 하면서 수정할 것
  tomcat:
    threads:
      max: ${TOMCAT_MAX_THREADS:200}
      min-spare: ${TOMCAT_MIN_SPARE_THREADS:10}
    max-connections: ${TOMCAT_MAX_CONNECTIONS:8192}
    accept-count: ${TOMCAT_ACCEPT_COUNT:100}

spring:
  application:
    name: x-umc-product
  profiles:
    # 기본적으로 local 프로필을 활성화, 실수로 prod에 접근하는 것을 방지함
    active: local

  docker:
    compose:
      # Local DB를 위한 Compose: 기본적으로 비활성화
      enabled: false
      lifecycle-management: start_and_stop

  # 메일 서버 설정
  mail:
    host: ${MAIL_HOST}
    port: ${MAIL_PORT}
    username: ${MAIL_USERNAME}
    password: ${MAIL_PASSWORD}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true # 연결 후 TLS 암호화 시작 (보안 연결)
            required: true # TLS 암호화 필수 (실패시 연결 차단)
          connectiontimeout: 5000 # SMTP 서버 연결 대기 시간 5초
          timeout: 5000 # 읽기(Read) 타임아웃 5초
          writetimeout: 5000 # 메일 쓰기 전송 타임아웃 5초

  # Thymeleaf 템플릿 엔진 설정
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html
    mode: HTML
    encoding: UTF-8
    cache: false  # 개발 환경에서는 캐시 비활성화, 운영에서는 true로 변경 필요

  datasource:
    url: ${DATABASE_URL}
    username: ${DATABASE_USERNAME}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver

    hikari:
      auto-commit: true

      maximum-pool-size: ${HIKARI_MAX_POOL_SIZE:10}
      minimum-idle: ${HIKARI_MIN_IDLE:10}

      # 3. 수명 및 타임아웃
      max-lifetime: 1800000       # 30분
      connection-timeout: 30000   # 30초
      validation-timeout: 5000    # 5초

      keepalive-time: 60000       # DB에 1분마다 생존 신고 (유휴 커넥션 방지)

  flyway:
    enabled: false # 필요 시 각 환경에 대한 설정에서 활성화하도록 함

  jpa:
    # database-platform은 SpringBoot가 hibernate-spatial 의존성을 기반으로 자동으로 선택함
    # 따라서 포함하지 않도록 함.
    hibernate:
      ddl-auto: validate
    open-in-view: false
    properties:
      hibernate:
        default_schema: public
        format_sql: true
        # dialect는 명시가 불필요해서 생략
        show_sql: false # p6spy가 있어서 꺼둠

  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope: profile, email
            redirect-uri: "{baseUrl}/api/v1/auth/oauth2/callback/{registrationId}"

          kakao:
            client-id: ${KAKAO_CLIENT_ID}
            client-secret: ${KAKAO_CLIENT_SECRET}
            client-authentication-method: client_secret_post
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/api/v1/auth/oauth2/callback/{registrationId}"
            scope: profile_nickname, account_email
            client-name: Kakao

        provider:
          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id

jwt:
  access-token-secret: ${JWT_ACCESS_TOKEN_SECRET}
  refresh-token-secret: ${JWT_REFRESH_TOKEN_SECRET}
  oauth-verification-token-secret: ${JWT_OAUTH_VERIFICATION_TOKEN_SECRET}
  email-verification-token-secret: ${JWT_EMAIL_VERIFICATION_TOKEN_SECRET}
  access-token-validity-in-seconds: ${JWT_ACCESS_TOKEN_VALIDITY_IN_SECONDS:3600}
  refresh-token-validity-in-seconds: ${JWT_REFRESH_TOKEN_VALIDITY_IN_SECONDS:604800}
  verification-token-validity-in-seconds: ${JWT_VERIFICATION_TOKEN_VALIDITY_IN_SECONDS:600}

# swagger 설정
springdoc:
  swagger-ui:
    path: /docs # Swagger 경로
    enabled: false # Swagger는 기본적으로 비활성화
    operations-sorter: method # API 정렬 (method, alpha)
    doc-expansion: none  # 모든 API를 접힌 상태로 표시
    #    default-models-expand-depth: -1  # 스키마 모델도 접힌 상태로
    # tag 정렬은 SwaggerTag에 명시된 대로 정렬할 것

  api-docs:
    path: /docs-json # API 문서 경로
    enabled: false

  show-actuator: false

logging:
  level:
    root: INFO

    # 애플리케이션 기본값
    com.umc.product: INFO

    # Spring Framework
    org.springframework.web: INFO
    org.springframework.security: INFO

    # JPA/Hibernate
    org.hibernate.SQL: WARN
    org.hibernate.orm.jdbc.bind: WARN  # 파라미터 숨김

    # 트랜잭션
    org.springframework.transaction: INFO
    org.springframework.orm.jpa: INFO

    # 시끄러운 로그 제거
    org.springframework.web.client.DefaultRestClient: WARN
    org.apache.http: WARN
    com.zaxxer.hikari: WARN

management:
  server:
    port: ${MANAGEMENT_PORT:9090}
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus,tracing"
  tracing:
    enabled: true
    sampling:
      probability: ${TRACE_SAMPLING_PROBABILITY:0.1}
    # 지금은 내보내지 않음, Grafana Tempo로 연동하도록 추후 추가
  #  otlp:
  #    tracing:
  #      endpoint: ${TEMPO_URL}

  metrics:
    enable:
      jvm: true
      process: true
      http: true
      jdbc: true # DB 쿼리 메트릭
      #      rabbitmq: true # messaging, 사용 시 추가
      system: true # CPU, 메모리 등 시스템 메트릭
      tomcat: true # 톰캣 스레드풀, 세션 메트릭
      hikaricp: true # HikariCP 커넥션 풀 메트릭
      logback: true # 로그 레벨별 카운트
      cache: true # 캐시 사용 시
      spring.security: true # Spring Security 인증 메트릭

  prometheus:
    metrics:
      export:
        enabled: true

app:
  base-url: ${APP_BASE_URL:http://localhost:${SERVER_PORT:8080}}
  firebase-configuration: ${FIREBASE_CONFIGURATION}
  swagger-auth:
    username: ${SWAGGER_AUTH_USERNAME:username}
    password: ${SWAGGER_AUTH_PASSWORD:password}
  oauth2:
    frontend-redirect-url: ${OAUTH2_FRONTEND_REDIRECT_URL}

storage:
  provider: s3

  s3:
    bucket-name: ${S3_BUCKET_NAME}
    region: ${S3_REGION:ap-northeast-2}
    access-key-id: ${S3_ACCESS_KEY_ID}
    secret-access-key: ${S3_SECRET_ACCESS_KEY}
    cloudfront:
      enabled: false
      private-key: ${CDN_PRIVATE_KEY}
      distribution-domain: https://cdn.example.com
      key-pair-id: ${CDN_KEY_PAIR_ID}

  gcs:
    project-id: ${GCS_PROJECT_ID}
    bucket-name: ${GCS_BUCKET_NAME}
    credentials-json: ${GCS_CREDENTIALS_JSON:}
    cdn:
      enabled: false
      base-url: https://cdn.example.com
      key-name: ${CDN_KEY_NAME}
      private-key: ${CDN_PRIVATE_KEY}

sentry:
  dsn: ${SENTRY_DSN}
  environment: ${spring.profiles.active}
  exception-resolver-order: -2147483647
  max-request-body-size: none
  send-default-pii: false
  traces-sample-rate: ${SENTRY_TRACES_SAMPLE_RATE:1.0}
